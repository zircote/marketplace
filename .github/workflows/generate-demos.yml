name: Generate Demos

on:
  workflow_dispatch:
    inputs:
      demo:
        description: 'Demo to generate (or "all")'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - nsip-discover
          - gh-prune
          - zircote-explore
          - datadog-monitor
          - docskills-pdf

permissions:
  contents: write

jobs:
  generate:
    name: Generate Demo GIFs
    runs-on: ubuntu-latest
    env:
      DEMO_CHOICE: ${{ inputs.demo }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg cmake libjson-c-dev libwebsockets-dev

      - name: Install ttyd
        run: |
          git clone https://github.com/tsl0922/ttyd.git
          cd ttyd
          mkdir build && cd build
          cmake ..
          make
          sudo make install

      - name: Install vhs
        run: |
          go install github.com/charmbracelet/vhs@latest
          echo "$HOME/go/bin" >> "$GITHUB_PATH"

      - name: Generate demos
        run: |
          cd demos

          # Validate demo choice
          case "$DEMO_CHOICE" in
            all)
              for tape in *.tape; do
                echo "Generating $tape..."
                vhs "$tape" || echo "Warning: $tape failed"
              done
              ;;
            nsip-discover|gh-prune|zircote-explore|datadog-monitor|docskills-pdf)
              vhs "${DEMO_CHOICE}.tape"
              ;;
            *)
              echo "Invalid demo choice"
              exit 1
              ;;
          esac

      - name: Commit generated GIFs
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add demos/*.gif

          if git diff --cached --quiet; then
            echo "No new GIFs generated"
          else
            git commit -m "chore(demos): regenerate demo GIFs

            ðŸ¤– Generated by GitHub Actions"
            git push
          fi
